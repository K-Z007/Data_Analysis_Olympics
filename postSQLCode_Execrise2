SET search_path = 'dbcamp_tableau';

SELECT 
	LEFT(REPLACE(UPPER(TRIM(c.country)), '.', ''), 3),
    -- Pull in pop_in_millions and medals_per_million 
    pop_in_millions,
    -- Add the three medal fields using one sum function
	SUM(COALESCE(bronze,0) + COALESCE(silver,0) + COALESCE(gold,0)) AS medals,
     SUM(COALESCE(bronze,0) + COALESCE(silver,0) + COALESCE(gold,0))/ CAST(pop_in_millions AS float) AS medals_per_million
FROM summer_games AS s
JOIN countries AS c
ON s.country_id = c.id
-- Add a join
JOIN country_stats AS cs
ON s.country_id = cs.country_id AND s.year = CAST(cs.year AS date)
WHERE pop_in_millions IS NOT NULL
GROUP BY c.country, pop_in_millions
-- Keep only the top 25 medals_per_million rows
ORDER BY medals_per_million DESC
